var SmartFish=(function(){var a={fish:{x:0,y:0,width:60,height:60,img:new Image(),horizontalSpeed:2,verticalSpeed:2,hitEdge:false,getNum:false},title:{x:0,y:0,img:new Image()},startButton:{x:0,y:0,img:new Image()},backGroundImg:new Image(),canvasWidth:0,canvasHeight:0,canvas:{},context:{},circles:[],circlesSpeed:[],circle:{width:40,height:40,horizontalSpeed:1,verticalSpeed:1},coordinates:[],connection:{},nums:[],results:[],selectId:0,selected:false,num:0,isTouch:"ontouchstart" in window,e_touchstart:this.isTouch?"touchstart":"mousedown",e_touchmove:this.isTouch?"touchmove":"mousemove",e_touchend:this.isTouch?"touchend":"mouseup"};return a})();window.SmartFish=SmartFish||{};(function(a){a.init=function(){a.backGroundImg.src="../images/seabed.jpg";a.fish.img.src="../images/greenfish.png";a.canvas=a.$("canvas");canvas.addEventListener(a.e_touchstart,a.mousedown);canvas.addEventListener(a.e_touchmove,a.mousemove);canvas.addEventListener(a.e_touchend,a.mouseup);a.context=a.canvas.getContext("2d");a.canvasWidth=a.canvas.width;a.canvasHeight=a.canvas.height;a.fish.x=a.getRandom(20,400);a.fish.y=a.getRandom(20,220);a.setScore(0);a.connect();setInterval(a.draw,100)}})(SmartFish);(function(SmartFish){SmartFish.connect=function(){SmartFish.connection=new WebSocket("ws://localhost:8080");SmartFish.connection.onopen=SmartFish.onopen;SmartFish.connection.onmessage=SmartFish.onmessage;SmartFish.connection.onerror=SmartFish.onerror};SmartFish.onopen=function(){console.log("onopen")};SmartFish.onmessage=function(message){if(SmartFish.nums.length<=1){SmartFish.connection.send("getData");console.log("message:"+message.data);SmartFish.circles=[];SmartFish.results=[];var json=eval("("+message.data.trim()+")");console.log(json);SmartFish.num=json.num;SmartFish.$("num").innerHTML=SmartFish.num;SmartFish.nums=json.nums;for(var i=0;i<SmartFish.nums.length;i++){SmartFish.createCircle(SmartFish.nums[i])}}};SmartFish.onerror=function(error){console.log("error")}})(SmartFish);(function(a){a.draw=function(){var b=a.context;b.clearRect(0,0,a.canvasWidth,a.canvasHeight);b.save();b.drawImage(a.backGroundImg,0,0,a.canvasWidth,a.canvasHeight);var c=a.getRandom(1,30);if(!a.fish.hitEdge||!a.fish.getNum){if(c==2||c==6){a.fish.horizontalSpeed=-a.fish.horizontalSpeed}else{if(c==1||c==7){a.fish.verticalSpeed=-a.fish.verticalSpeed}}}a.fish.x=a.fish.x+a.fish.horizontalSpeed;a.fish.y=a.fish.y+a.fish.verticalSpeed;b.translate(a.fish.x+(a.fish.width/2),a.fish.y+(a.fish.height/2));if(a.fish.horizontalSpeed>0){b.rotate(Math.PI)}else{b.rotate(0)}b.drawImage(a.fish.img,-(a.fish.width/2),-(a.fish.height/2),a.fish.width,a.fish.height);a.updateCircle();a.fish.hitEdge=false;a.hasFishHitEdge();b.restore();if(a.nums.length<=1){a.connection.send("getData")}};a.createCircle=function(b){var d=a.circles.length;var e=document.createElement("div");e.id="circle_"+d;e.className="circle";var f=a.getXY();e.style.left=f.x+"px";e.style.top=f.y+"px";e.left=f.x;e.top=f.y;e.horizontalSpeed=a.circle.horizontalSpeed;e.verticalSpeed=a.circle.verticalSpeed;e.hitEdge=false;e.hasCollide=false;e.selected=false;e.hasCollided=false;e.unselectable="on";e.num=b;var c=b;e.innerHTML=c;document.body.appendChild(e);a.coordinates.push(f);e.addEventListener(a.e_touchstart,a.circle_mousedown);e.addEventListener(a.e_touchend,a.circle_mouseup);a.circles.push(e)};a.addCircle=function(b,g,f,e){var d=document.createElement("div");d.id=g;d.className="circle";d.style.left=f+"px";d.style.top=e+"px";d.left=f;d.top=f;d.horizontalSpeed=a.circle.horizontalSpeed;d.verticalSpeed=a.circle.verticalSpeed;d.hitEdge=false;d.hasCollide=false;d.selected=true;d.hasCollided=false;d.unselectable="on";d.num=b;var c=b;d.innerHTML=c;document.body.appendChild(d);d.addEventListener("mousedown",a.circle_mousedown);d.addEventListener("mouseup",a.circle_mouseup);a.circles.push(d);return d};a.updateCircle=function(){var d=0;var f=0;var e=0;for(var c=0;c<a.circles.length;c++){if(a.circles[c].selected||a.circles[c].hasCollided){continue}d=a.getRandom(1,30);if(!a.circles[c].hitEdge||!a.circles[c].hasCollide){if(d==2||d==6){a.circles[c].horizontalSpeed=-a.circles[c].horizontalSpeed}else{if(d==1||d==7){a.circles[c].verticalSpeed=-a.circles[c].verticalSpeed}}}f=a.circles[c].left+a.circles[c].horizontalSpeed;e=a.circles[c].top+a.circles[c].verticalSpeed;a.circles[c].style.left=f+"px";a.circles[c].style.top=e+"px";a.circles[c].left=f;a.circles[c].top=e;a.circles[c].hitEdge=false;a.circles[c].hasCollide=false;for(var b=c;b<a.circles.length;b++){}a.hasCircleHitEdge(a.circles[c])}};a.hasFishHitEdge=function(){if(a.fish.x>a.canvasWidth-a.fish.width){if(a.fish.horizontalSpeed>0){a.fish.hitEdge=true;a.fish.horizontalSpeed=-a.fish.horizontalSpeed}}if(a.fish.x<-10){if(a.fish.horizontalSpeed<0){a.fish.hitEdge=true;a.fish.horizontalSpeed=-a.fish.horizontalSpeed}}if(a.fish.y>a.canvasHeight-a.fish.height){if(a.fish.verticalSpeed>0){a.fish.hitEdge=true;a.fish.verticalSpeed=-a.fish.verticalSpeed}}if(a.fish.y<0){if(a.fish.verticalSpeed<0){a.fish.hitEdge=true;a.fish.verticalSpeed=-a.fish.verticalSpeed}}};a.hasCircleHitEdge=function(b){if(b.left>a.canvasWidth-a.circle.width){if(b.horizontalSpeed>0){b.hitEdge=true;b.horizontalSpeed=-b.horizontalSpeed}}if(b.left<-10){if(b.horizontalSpeed<0){b.hitEdge=true;b.horizontalSpeed=-b.horizontalSpeed}}if(b.top>a.canvasHeight-a.circle.height){if(b.verticalSpeed>0){b.hitEdge=true;b.verticalSpeed=-b.verticalSpeed}}if(b.top<0){if(b.verticalSpeed<0){b.hitEdge=true;b.verticalSpeed=-b.verticalSpeed}}};a.hasCircleCollide=function(h,g){var c=h.left+a.circle.width/2;var e=h.top+a.circle.width/2;var b=g.left+a.circle.width/2;var d=g.top+a.circle.width/2;var f=Math.sqrt(Math.pow((c-b),2)+Math.pow((e-d),2));if(f<a.circle.width){h.hasCollide=true;h.horizontalSpeed=-h.horizontalSpeed;h.verticalSpeed=-h.verticalSpeed;g.hasCollide=true;g.horizontalSpeed=-g.horizontalSpeed;g.verticalSpeed=-g.verticalSpeed}};a.getCircleCollided=function(h){var c=h.left+a.circle.width/2;var f=h.top+a.circle.width/2;var b=0;var e=0;var g=0;for(var d=0;d<a.circles.length;d++){if(h.id==a.circles[d].id){continue}b=a.circles[d].left+a.circle.width/2;e=a.circles[d].top+a.circle.width/2;g=Math.sqrt(Math.pow((c-b),2)+Math.pow((f-e),2));if(g<a.circle.width-10){h.hasCollided=true;return a.circles[d]}}return null};a.hasFishCircleCollide=function(){var b=false;if(a.results.length>0){var d=a.fish.x+a.fish.width/2;var f=a.fish.y+a.fish.height/2;var c=a.results[0].left+a.circle.width/2;var e=a.results[0].top+a.circle.width/2;var g=0;g=Math.sqrt(Math.pow((d-c),2)+Math.pow((f-e),2));console.log("r:"+g);if(g<(a.fish.width/2+a.circle.width/2)){b=true}if(a.results.length==1){}else{var i=a.results[1].left;var h=a.results[1].top;a.calculateFishDirection(i,h)}}return b};a.calculateResult=function(e,c){var j=parseInt(e.innerHTML);var g=parseInt(c.innerHTML);var l=e.id;var k=c.id;var b=e.left;var h=e.top;document.body.removeChild(e);document.body.removeChild(c);var f=[];for(var d=0;d<a.circles.length;d++){if(a.circles[d].id==l||a.circles[d].id==k){continue}f.push(a.circles[d])}a.circles=f;a.nums.shift();circle=a.addCircle((j+g),l,b,h);if((j+g)==a.num){a.fish.x=b;a.fish.y=h;a.results.push(circle);a.calculateFishDirection(b,h);a.updateFishAndCircle()}else{}};a.calculateFishDirection=function(c,b){a.fish.getNum=true;if(a.fish.x<c+a.circle.width/2&&a.fish.y<b+a.circle.width/2){if(a.fish.horizontalSpeed<0){a.fish.horizontalSpeed=-a.fish.horizontalSpeed}if(a.fish.verticalSpeed<0){a.fish.verticalSpeed=-a.fish.verticalSpeed}}if(a.fish.x>c+a.circle.width/2&&a.fish.y<b+a.circle.width/2){if(a.fish.horizontalSpeed>0){a.fish.horizontalSpeed=-a.fish.horizontalSpeed}if(a.fish.verticalSpeed<0){a.fish.verticalSpeed=-a.fish.verticalSpeed}}if(a.fish.x<c+a.circle.width/2&&a.fish.y>b+a.circle.width/2){if(a.fish.horizontalSpeed<0){a.fish.horizontalSpeed=-a.fish.horizontalSpeed}if(a.fish.verticalSpeed>0){a.fish.verticalSpeed=-a.fish.verticalSpeed}}if(a.fish.x>c+a.circle.width/2&&a.fish.y>b+a.circle.width/2){if(a.fish.horizontalSpeed>0){a.fish.horizontalSpeed=-a.fish.horizontalSpeed}if(a.fish.verticalSpeed>0){a.fish.verticalSpeed=-a.fish.verticalSpeed}}};a.updateFishAndCircle=function(){if(a.results.length>0){var c=a.results[0];var e=c.id;a.setScore(10);document.body.removeChild(c);var d=[];for(var b=0;b<a.circles.length;b++){if(a.circles[b].id==e){continue}d.push(a.circles[b])}a.circles=d;a.results.shift();a.nums.shift();if(a.results.length==1){a.fish.getNum=false}else{}}else{a.fish.getNum=false}};a.getCircle=function(b){};a.getScore=function(){var b=a.$("result");return b.dataset.score};a.setScore=function(c){var b=a.$("result");c=parseInt(a.getScore())+c;b.dataset.score=c;b.innerHTML="分数："+c}})(SmartFish);(function(a){a.click=function(){};a.circle_mousedown=function(b){if(b.touches){b=b.touches[0]}b.preventDefault();a.selectId=this.id;a.selected=true;startX=b.pageX;startY=b.pageY;this.selected=true};a.circle_mousemove=function(b){if(b.touches){b=b.touches[0]}b.preventDefault();if(this.selected){this.style.left=(b.x-b.offsetX)+"px";this.style.top=(b.y-b.offsetY)+"px";this.left=b.x-b.offsetX;this.top=b.y-b.offsetY;this.hitEdge=false;this.hasCollide=false}};a.circle_mouseup=function(c){if(c.touches){c=c.touches[0]}c.preventDefault();a.selectId="";a.selected=false;this.selected=false;var b=a.getCircleCollided(this);if(b){a.calculateResult(this,b)}};a.mousedown=function(b){};a.mousemove=function(d){if(d.touches){d=d.touches[0]}d.preventDefault();if(a.selected){var c=a.$(a.selectId);var f=d.x-d.x;var b=d.x-d.y;if(f==0){c.style.left=d.x+"px"}else{if(f>0){c.style.left=(d.x+a.circle.width/2)+"px"}else{if(b<0){c.style.left=(d.x-a.circle.width/2)+"px"}}}if(b==0){c.style.top=d.y+"px"}else{if(b>0){c.style.top=(d.y+a.circle.width/2)+"px"}else{if(b<0){c.style.top=(d.y-a.circle.width/2)+"px"}}}c.left=d.x;c.top=d.y;c.hitEdge=false;c.hasCollide=false}};a.mouseup=function(c){if(a.selected){var b=a.$(a.selectId);a.selectId="";a.selected=false;b.selected=false}}})(SmartFish);(function(a){a.getRandom=function(c,b){c=(c||c===0)?c:0;b=(b||b===0)?b:0;return Math.floor((b-c+1)*Math.random())+c};a.getXY=function(){var b=a.getRandom(10,440);var c=a.getRandom(10,270);return{x:b,y:c}};a.setXY=function(d,c){for(var b=0;b<c.length;b++){if(d.x>c[b].x-20&&d.x<c[b].x+20){var d=a.getXY();return a.setXY(d,c)}if(d.y>c[b].y-20&&d.y<c[b].y+20){var d=a.getXY();return a.setXY(d,c)}}return d};a.$=function(b){return document.getElementById(b)}})(SmartFish);SmartFish.init();